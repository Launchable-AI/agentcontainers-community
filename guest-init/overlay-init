#!/bin/sh
# overlay-init - In-guest OverlayFS setup for Firecracker VMs
#
# Based on firecracker-containerd's overlay-init:
# https://github.com/firecracker-microvm/firecracker-containerd
#
# Usage:
#   Kernel boot args: init=/sbin/overlay-init overlay_root=vdb
#
# IMPORTANT: The rootfs MUST have /overlay and /mnt/rom directories pre-created!
#
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

# Parse kernel command line for overlay_root parameter
for arg in $(cat /proc/cmdline); do
    case "$arg" in
        overlay_root=*)
            overlay_root="${arg#overlay_root=}"
            ;;
    esac
done

# pivot_root to the overlay filesystem
pivot() {
    local rw_root work_dir
    rw_root="$1"
    work_dir="$2"

    /bin/mount \
        -o noatime,lowerdir=/,upperdir=${rw_root},workdir=${work_dir} \
        -t overlay "overlayfs:${rw_root}" /mnt

    cd /mnt
    pivot_root . rom
}

# Set up the overlay filesystem
do_overlay() {
    # Mount the overlay storage on /overlay (directory must pre-exist)
    if [ "$overlay_root" = "ram" ] || [ -z "$overlay_root" ]; then
        # Use tmpfs - changes are lost on reboot
        /bin/mount -t tmpfs -o noatime,mode=0755 tmpfs /overlay
    else
        # Use block device - changes persist
        /bin/mount -t ext4 -o noatime "/dev/$overlay_root" /overlay
    fi

    # Create overlayfs directories on the writable overlay storage
    mkdir -p /overlay/upper /overlay/work

    # Pivot to the overlay
    pivot /overlay/upper /overlay/work
}

# Validate block device if specified
if [ -n "$overlay_root" ] && [ "$overlay_root" != "ram" ]; then
    if [ ! -b "/dev/$overlay_root" ]; then
        echo "[overlay-init] FATAL: /dev/$overlay_root does not exist"
        exec /sbin/init "$@"
    fi
fi

# Set up overlay
do_overlay

# Now we're in the new root - exec real init
exec chroot . /sbin/init "$@"
